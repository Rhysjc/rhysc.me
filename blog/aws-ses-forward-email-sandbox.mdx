---
title: How to forward custom domain email with SES while you're still in the sandbox
date: 2022-08-26
slug: aws-ses-forward-email-sandbox
ogImage: blog/aws-ses-forward-email-sandbox.png
---
import { BlogNote } from '../src/components/BlogNote';

Initially I included my personal email in the contact link in the header on this site. However, I'd rather not have my primary email out in the open and so I wanted to have a contact email on this domain. This is pretty easy to do if you don't mind shelling out for Google Workspace, but given this domain costs me about ¬£5 a year and my AWS bill is negligible, that would 10x my annual spend.

There's a [pretty good guide](https://aws.amazon.com/blogs/messaging-and-targeting/forward-incoming-email-to-an-external-destination/) on how you can set up a custom domain email proxy if your SES account is out of the sandbox. As it happens, I'm not in the sandbox (I just didn't want to deploy a lambda to do this just yet) and so I know first hand that AWS can make it pretty difficult to get out of.

I'll start this by admitting this isn't a perfect solution. The emails you end up receiving are full of junk you don't need, and it's quite hard to parse the contents of the email you've been sent. You could probably write a script that you can paste these emails into and get out what you need.

That said, if you're in the sandbox and just want to be able to receive email on your custom domain and don't mind a less than perfect experience, this'll do the job.

## CloudFormation
I've configured this with CloudFormation (as I do with most things). I'll be going through it service by service and so it should be fairly simple to recreate this through the AWS console if you don't want to use CloudFormation. That said, deploying a CloudFormation stack isn't too difficult, so you may be better off just doing that ü§∑‚Äç‚ôÇÔ∏è.

## Assumptions
I've assumed here that you've already bought a domain and set up a hosted zone in Route 53.

## SNS
We'll first need to configure an SNS topic and subscription.

<BlogNote>You'll receive an email from AWS when this is deployed. There'll be a `SubscribeURL` field in the JSON, which you'll need to paste into the SNS dashboard to confirm.</BlogNote>

```yaml
EmailProxySNSTopic:
  Type : AWS::SNS::Topic
  Properties:
    DisplayName: 'Email Proxy'
    TopicName: email-proxy

EmailProxySNSSubscription:
  Type: AWS::SNS::Subscription
  Properties:
    TopicArn: !Ref EmailProxySNSTopic
    Protocol: email-json
    Endpoint: {YOUR EMAIL HERE}
```

All we've done here is tell SNS to forward the message JSON to your email when the topic receives a notification from SES. You can swap out the display name, and topic name for whatever you'd like, but the most important thing is to replace `{YOUR EMAIL HERE}` with your personal email.

## SES
We need to add an identity to SES and then set up a receipt rule which will notify our SNS topic when a certain address gets an email.

<BlogNote>When you deploy this, you'll need to verify the identity. If your domain is hosted in Route 53 there'll be a button on SES you can click to do it for you. You'll also need to set the receipt rule as active.</BlogNote>

```yaml
EmailIdentity:
  Type: AWS::SES::EmailIdentity
  Properties:
    EmailIdentity: {YOUR DOMAIN}

EmailReceiptRuleSet:
  Type: AWS::SES::ReceiptRuleSet
  Properties:
    RuleSetName: email-proxy-ruleset

EmailReceiptRule:
  Type: AWS::SES::ReceiptRule
  Properties:
    RuleSetName: !Ref EmailReceiptRuleSet
    Rule:
      Enabled: True
      Name: ForwardToSNS
      Recipients:
        - {RECEIPT EMAIL}
      Actions:
        - SNSAction:
            TopicArn: !Ref EmailProxySNSTopic
```

You'll need to replace `{YOUR DOMAIN}` with your Route 53 domain, and `{RECEIPT EMAIL}` with the email you'll be making public.

## Route 53
Finally you'll want to add an MX record to your hosted zone so that any emails sent to your domain reach SES.
```yaml
MXRecord:
  Type: AWS::Route53::RecordSet
  Properties:
    HostedZoneId: {HOSTED ZONE ID}
    Name: {YOUR DOMAIN}
    Type: MX
    TTL: 3600
    ResourceRecords:
      - '10 inbound-smtp.us-east-1.amazonaws.com'
```
I'm set up in `us-east-1`, but you'll need to swap in your region in the `ResourceRecords` list. Also be sure to add in your hosted zone ID and domain (the same one as the `EmailIdentity` above)!

## The emails
As I mentioned above, the emails you end up receiving from this are not pretty! You get a JSON object which is the SNS message, with the SES notification body nested inside `Message`. This is yet another JSON object, which has a `content` field. The value of this field is the MIME format of the email - at the very end of which is the contents you're looking for. By no means a good solution, but it works for now!